<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Account - Pets Shop</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Montserrat&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            display: block;
            min-height: 100vh;
            position: relative;
            padding-bottom: 80px;
            overflow-y: auto;
        }
        .account-container {
            max-width: 800px;
            margin: 50px auto;
            text-align: center;
            position: relative;
        }
        .mascot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .mascot-item {
            background: #FFFFFF;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid #DCE4F2;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .mascot-item img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            border: 1px solid #DCE4F2;
        }
        .mascot-item .download-btn {
            display: block;
            margin: 10px auto 0;
            padding: 8px 16px;
            font-size: 0.9em;
        }
        .home-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 12px 24px;
            background: #205ADA;
            color: white;
            border: none;
            border-radius: 12px;
        }
        .wallet-btn {
            padding: 12px 24px;
            font-size: 1em;
        }
        .site-footer {
            background: #333333;
            padding: 20px;
            text-align: center;
            width: 100%;
            color: white;
            position: absolute;
            bottom: 0;
            left: 0;
        }
        .site-footer a {
            color: white;
            text-decoration: none;
        }
        .site-footer a:hover {
            text-decoration: underline;
        }
        .flower-decoration {
            position: absolute;
            opacity: 0.2;
            z-index: -1;
        }
        .flower-top-left {
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
        }
        .flower-bottom-right {
            bottom: 90px;
            right: 10px;
            width: 40px;
            height: 40px;
        }
    </style>
</head>
<body>
    <button class="home-btn" onclick="window.location.href='index.html'">Home</button>
    <button class="wallet-btn"></button>
    <div class="account-container">
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE5Ljk5OTkgMjYuNjY2N0MyMy4zMTM4IDI2LjY2NjcgMjYuMDAwMSAyMy45ODAxIDI2LjAwMDEgMjAuNjY2NkMyNi4wMDAxIDE3LjM1MjcgMjMuMzEzOCAxNC42NjY3IDE5Ljk5OTkgMTQuNjY2N0MxNi42ODYxIDE0LjY2NjcgMTQuMDAwMSAxNy4zNTI3IDE0LjAwMDEgMjAuNjY2NkMxNC4wMDAxIDIzLjk4MDEgMTYuNjg2MSAyNi42NjY3IDE5Ljk5OTkgMjYuNjY2N1oiIGZpbGw9IiNGOEI1QzIiLz4KPHBhdGggZD0iTTE5Ljk5OTkgMzMuMzMzM0MyNi42Mjc5IDMzLjMzMzMgMzIuMDAwMSAyNy45NjEyIDMyLjAwMDEgMjEuMzMzM0MzMi4wMDAxIDE0LjcwNTQgMjYuNjI3OSAxMy4zMzMzIDE5Ljk5OTkgMTMuMzMzM0MxMy4zNzIxIDEzLjMzMzMgOC4wMDAwNSAxOC43MDU0IDguMDAwMDUgMjEuMzMzM0M4LjAwMDA1IDI3Ljk2MTIgMTMuMzcyMSAzMy4zMzMzIDE5Ljk5OTkgMzMuMzMzM1oiIGZpbGw9IiNBNkQ1QSIvPgo8cGF0aCBkPSJNMTkuOTk5OSAxMy4zMzM0QzIzLjMxMzggMTMuMzMzNCAyNi4wMDAxIDEwLjY0NzMgMjYuMDAwMSAxMC4wMDAxQzI2LjAwMDEgOS4zNTI4MSAyMy4zMTM4IDYuNjY2OCAxOS45OTk5IDYuNjY2OEMxNi42ODYxIDYuNjY2OCAxNC4wMDAxIDkuMzUyODEgMTQuMDAwMSAxMC4wMDAxQzE0LjAwMDEgMTAuNjQ3MyAxNi42ODYxIDEzLjMzMzQgMTkuOTk5OSAxMy4zMzM0WiIgZmlsbD0iI0Y3RTI5QSIvPgo8L3N2Zz4K" class="flower-decoration flower-top-left" alt="Flower">
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE5Ljk5OTkgMjYuNjY2N0MyMy4zMTM4IDI2LjY2NjcgMjYuMDAwMSAyMy45ODAxIDI2LjAwMDEgMjAuNjY2NkMyNi4wMDAxIDE3LjM1MjcgMjMuMzEzOCAxNC42NjY3IDE5Ljk5OTkgMTQuNjY2N0MxNi42ODYxIDE0LjY2NjcgMTQuMDAwMSAxNy4zNTI3IDE0LjAwMDEgMjAuNjY2NkMxNC4wMDAxIDIzLjk4MDEgMTYuNjg2MSAyNi42NjY3IDE5Ljk5OTkgMjYuNjY2N1oiIGZpbGw9IiNGOEI1QzIiLz4KPHBhdGggZD0iTTE5Ljk5OTkgMzMuMzMzM0MyNi42Mjc5IDMzLjMzMzMgMzIuMDAwMSAyNy45NjEyIDMyLjAwMDEgMjEuMzMzM0MzMi4wMDAxIDE0LjcwNTQgMjYuNjI3OSAxMy4zMzMzIDE5Ljk5OTkgMTMuMzMzM0MxMy4zNzIxIDEzLjMzMzMgOC4wMDAwNSAxOC43MDU0IDguMDAwMDUgMjEuMzMzM0M4LjAwMDA1IDI3Ljk2MTIgMTMuMzcyMSAzMy4zMzMzIDE5Ljk5OTkgMzMuMzMzM1oiIGZpbGw9IiNBNkQ1QSIvPgo8cGF0aCBkPSJNMTkuOTk5OSAxMy4zMzM0QzIzLjMxMzggMTMuMzMzNCAyNi4wMDAxIDEwLjY0NzMgMjYuMDAwMSAxMC4wMDAxQzI2LjAwMDEgOS4zNTI4MSAyMy4zMTM4IDYuNjY2OCAxOS45OTk5IDYuNjY2OEMxNi42ODYxIDYuNjY2OCAxNC4wMDAxIDkuMzUyODEgMTQuMDAwMSAxMC4wMDAxQzE0LjAwMDEgMTAuNjQ3MyAxNi42ODYxIDEzLjMzMzQgMTkuOTk5OSAxMy4zMzM0WiIgZmlsbD0iI0Y3RTI5QSIvPgo8L3N2Zz4K" class="flower-decoration flower-bottom-right" alt="Flower">
        <h1>My Purchases</h1>
        <p>Here are all the mascots you've unlocked!</p>
        <div id="mascot-grid" class="mascot-grid"></div>
    </div>
    <footer class="site-footer">
        <a href="https://www.etsy.com/fr/shop/NeoStreamlabs">Visit my shop</a>
    </footer>

    <script src="node_modules/web3/dist/web3.min.js"></script>
    <script>
        const contractAddress = "0x6e7BB75a1B98362dD98DBBEdF294D3F2D56D1658";
        const contractABI = [
            {"inputs": [{"internalType": "address", "name": "_usdtAddress", "type": "address"}],"stateMutability": "nonpayable","type": "constructor"},
            {"anonymous": false,"inputs": [{"indexed": false,"internalType": "address","name": "buyer","type": "address"},{"indexed": false,"internalType": "uint256","name": "characterId","type": "uint256"}],"name": "BoxPurchased","type": "event"},
            {"inputs": [],"name": "buyBox","outputs": [],"stateMutability": "nonpayable","type": "function"},
            {"inputs": [],"name": "buyBoxWithEth","outputs": [],"stateMutability": "payable","type": "function"},
            {"inputs": [],"name": "withdraw","outputs": [],"stateMutability": "nonpayable","type": "function"},
            {"inputs": [],"name": "boxPrice","outputs": [{"internalType": "uint256","name": "","type": "uint256"}],"stateMutability": "view","type": "function"},
            {"inputs": [],"name": "MAX_CHARACTERS","outputs": [{"internalType": "uint256","name": "","type": "uint256"}],"stateMutability": "view","type": "function"},
            {"inputs": [],"name": "owner","outputs": [{"internalType": "address","name": "","type": "address"}],"stateMutability": "view","type": "function"},
            {"inputs": [],"name": "usdt","outputs": [{"internalType": "contract IERC20","name": "","type": "address"}],"stateMutability": "view","type": "function"}
        ];
        const charactersImg = Array.from({ length: 7 }, (_, i) => `images/mascot-${i}.png`);

        async function initWeb3() {
            if (typeof window.ethereum === "undefined") {
                alert("Please install MetaMask!");
                return null;
            }
            const web3 = new Web3(window.ethereum);
            try {
                const accounts = await web3.eth.getAccounts();
                console.log("Connected account:", accounts[0]);
                const shortAddress = `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
                document.querySelector(".wallet-btn").textContent = shortAddress;
                return web3;
            } catch (error) {
                console.error("Error connecting wallet:", error);
                return null;
            }
        }

        async function loadPurchases() {
            const web3 = await initWeb3();
            if (!web3) return;

            const contract = new web3.eth.Contract(contractABI, contractAddress);
            try {
                const accounts = await web3.eth.getAccounts();
                const fromBlock = 22340000;
                const latestBlock = Number(await web3.eth.getBlockNumber());
                console.log("Latest block:", latestBlock);
                console.log("Searching from block:", fromBlock);

                const events = await contract.getPastEvents("BoxPurchased", {
                    fromBlock: fromBlock,
                    toBlock: "latest"
                });
                console.log("All events:", events);

                const userEvents = events.filter(event => 
                    event.returnValues.buyer.toLowerCase() === accounts[0].toLowerCase()
                );
                console.log("Filtered events for user:", userEvents);

                const mascotGrid = document.getElementById("mascot-grid");
                if (userEvents.length === 0) {
                    mascotGrid.innerHTML = "<p>No purchases found for this account since block 22340000.</p>";
                } else {
                    userEvents.forEach(event => {
                        const characterId = Number(event.returnValues.characterId);
                        console.log("Adding mascot:", characterId);
                        const div = document.createElement("div");
                        div.className = "mascot-item";
                        const img = document.createElement("img");
                        img.src = charactersImg[characterId];
                        const downloadBtn = document.createElement("button");
                        downloadBtn.textContent = "Download";
                        downloadBtn.className = "download-btn";
                        downloadBtn.onclick = () => window.location.href = "https://drive.google.com/uc?export=download&id=1CGB5Hw5aCVdDit-We_Al4aT-3s4dk_RX";
                        div.appendChild(img);
                        div.appendChild(downloadBtn);
                        mascotGrid.appendChild(div);
                    });
                }
            } catch (error) {
                console.error("Error loading purchases:", error);
                document.getElementById("mascot-grid").innerHTML = "<p>Error loading purchases. Check console.</p>";
            }
        }

        // Appel initial pour remplir le bouton wallet
        initWeb3().then(() => console.log("Wallet initialized"));
        window.onload = loadPurchases;
    </script>
</body>
</html>